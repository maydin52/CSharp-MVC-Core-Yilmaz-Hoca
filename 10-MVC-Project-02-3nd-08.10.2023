
Controller iÃ§erisindeki Token nedir?
[ValidateAntiForgeryToken]
web uygulamalarÄ±nda sizin formunu dÄ±ÅŸÄ±nda baÅŸka ortamlardan veri gelmesi saÄŸlanabiliyor.
Bu onu bozuyor.
Arkada bir token oluÅŸturuyor ve bunu Ã¶n yÃ¼ze gÃ¶nderiyor.
Daha sonra serverla bu token aynÄ± olduÄŸu iÃ§in, yani baÅŸka bir yerden geldiÄŸinde bu token bilgisi olmayacaÄŸÄ± iÃ§in iÅŸlemin yapÄ±lmasÄ±nÄ± engeller.
Bu konu ayrÄ±ca anlatÄ±lacak daha sonra web servisleri anlatÄ±rken. 
JWT Json Web Token teknolojisi. Servislerin gÃ¼venliÄŸi konusunda Ã§ok kullanÄ±lÄ±yor. Zamana baÄŸlÄ± mesela 10 dk da bir tokeni deÄŸiÅŸtir diyebiliyor. Adam onu buluncaya kadar token deÄŸiÅŸiyor zaten.
jwt.io kendi resmi sitesinden baktÄ±k. Bunun ilginÃ§ bir kullanÄ±mÄ± var. ÃœÃ§ parÃ§adan oluÅŸuyor. Sitede renklendirilmiÅŸ.
Token 50 yÄ±llÄ±k teknoloji. WCF i anlatÄ±rken de token teknolojisini kullanÄ±yorduk. 
Token bir madalyonun iki parÃ§asÄ± gibi.
Client geldiÄŸinde tokenlar aynÄ±ysa bu iki kiÅŸi birbirini tanÄ±yor.
Sunucu oluÅŸturuyor. Bir kopyasÄ± bende bir kopyasÄ± clientta.
Tokenlar hashlenmiÅŸ tutuluyor. 

Sessiondaki 20 dk hareketsiz kalÄ±rsa atma olayÄ± farklÄ±. 
Core da session kullanÄ±mÄ± Ã§ok farklÄ±. DÃ¼z mantÄ±kla kullanamÄ±yorsunuz.
Core Ã¶ncesi sessionlarÄ± istediÄŸiniz gibi kullanabiliyordunuz. Core ile birlikte ilgili ayarlarÄ± yapmadan  session larÄ± kullanamÄ±yorsunuz.
Session kullanÄ±cÄ± adÄ± ve ÅŸifre ile sisteme giriÅŸ yaptÄ±nÄ±z diyelim. GiriÅŸ yaptÄ±ktan sonra sistem arka planda bir session oluÅŸturuyor. 
Bu sessionlarÄ± (herhangi bir ayarlama yapÄ±lmazsa standart ayarÄ± 20 dk.) mekanizma siz pc den uzaklaÅŸtÄ±ktan sonra klavye ve fare eventleri kesildikten sonra 
session Ã¶ldÃ¼rÃ¼lÃ¼r ve login ekranÄ±na atÄ±yor.
(core Ã¶nce 1 dk nÄ±n altÄ±na dÃ¼ÅŸemiyordunuz) (core da sn veya msn cinsinden session oluÅŸturulabiliyor.)
MantÄ±k token gibi. Ä°ki tarafta da session id bilgisi oluÅŸturuluyor. Ä°kisi aynÄ± deÄŸilse bir taraf dÃ¼ÅŸtÃ¼ÄŸÃ¼ iÃ§in null olduÄŸu iÃ§in oturum kapatÄ±lÄ±yor.

Hoca 1 lira bÄ±rakÄ±p gitmenin dÄ±ÅŸÄ±nda o sayfaya tÄ±klanÄ±p tÄ±klanmadÄ±ÄŸÄ±nÄ±n kontrol ediyormu araÅŸtÄ±racak.

MS Identity konusunda profesyonel Ã§Ã¶zÃ¼m Ã§Ä±karmÄ±ÅŸ. SÄ±fÄ±rdan yazÄ±labilir ama riskleri var. 

-------------------------------------------
MODELLER REVÄ°ZE SONRASI SON DURUM;

VÄ°EWMODELS KLASÃ–RÃœ Ä°Ã‡Ä°NDE;
public class AuthorVM
    {
        public Author Author { get; set; }
        public AuthorDetail? AuthorDetail { get; set; }
    }

public class AppUser:IdentityUser
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public string Address { get; set; }
    }

public class Author
    {
        public int AuthorID { get; set; }
        public string FirstName { get; set; }
        public string LastName { get; set; }

        [NotMapped]
        public string FullName { get => FirstName + " " + LastName; }

        public AuthorDetail? AuthorDetail { get; set; }
        public ICollection<BookAuthor>? AuthorBooks { get; set; }
    }

public class AuthorDetail
    {
        [ForeignKey("Author")]
        public int AuthorDetailID { get; set; }

        [DisplayFormat(DataFormatString ="{0:d}")]
        public DateTime?  BirthDate { get; set; }
        public string? Region { get; set; }
        public string? Biography { get; set; }


        public Author? Author { get; set; }
    }

public class Book
    {
        public int BookID { get; set; }
        public string BookName { get; set; }
        public DateTime? ReleaseDate { get; set; }
        public string CoverImagePath { get; set; }
        
        [NotMapped]
        public IFormFile CoverImage { get; set;}
        public decimal Price { get; set; }

        public int CategoryID { get; set; }


        public Category? Category { get; set; }
        public ICollection<BookAuthor>? BookAuthors  { get; set; }
    }

public class BookAuthor
    {
        [Key]
        public int BAID { get; set; }
        public int BookID { get; set; }
        public int AuthorID { get; set; }

        public Book? Book { get; set; }
        public Author? Author { get; set; }
    }

public class Category
    {
        public int CategoryID { get; set; }
        public string CategoryName { get; set; }

        public ICollection<Book>? Books { get; set; }
    }


-------------------------------------------


1. Area - AdminPanel - Panel 

Index.cshtml bir Ã¶nceki gÃ¼ndeki eski. AÅŸaÄŸÄ±daki sekilde revize.

<h1>Admin Panel Sayfasi....</h1>

<ul>
    <li><a asp-area="AdminPanel" asp-controller="Categories" asp-action="Index">Kategoriler</a></li>
    <li><a asp-area="AdminPanel" asp-controller="Authors" asp-action="Index">Yazarlar</a></li>
    <li><a asp-area="AdminPanel" asp-controller="Books" asp-action="Index">Kitaplar</a></li>
</ul>

PK FK iliÅŸkisi gereÄŸi eÄŸer kitap tablosuyla yazar tablosunu iliÅŸkilendireceksem Ã¶nce yazar tablosunu halletmeliyiz.

------

2. Author ve AuthorDetail tablolarÄ± birleÅŸtirilerek tek ekranda veri giriliÅŸi


2.a Ä°ki tabloyu view e taÅŸÄ±mak iÃ§in; Models klasÃ¶rÃ¼ altÄ±nda ViewModels klasÃ¶rÃ¼ aÃ§arak onun altÄ±na AuthorVM classÄ± ekliyoruz.

 public class AuthorVM
    {
        public Author Author { get; set; }
        public AuthorDetail? AuthorDetail { get; set; }
    }


2.b AuthorsController Ä± oluÅŸturduk.

    [Area("AdminPanel")]
    public class AuthorsController : Controller
    {
        private readonly ApplicationDbContext _context;

        public AuthorsController(ApplicationDbContext context)
        {
            _context = context;
        }

        public IActionResult Index()
        {

            return View(_context.Authors.Include("AuthorDetail").ToList());
        }

        public IActionResult Create()
        {
            return View();
        }


        //UNIT OF WORK OLMADAN Ä°KÄ° DEFA SAVE Ä°LE. DÄ°KKAT MAHSURU VAR.
        //[HttpPost]
        //public IActionResult Create(AuthorVM authorVM)
        //{    
            //if (ModelState.IsValid)
            //{              
               //Ä°ki SaveChanges() ile; FAKAT BURADA ÅžÃ–YLE BÄ°R SIKINTI VAR; MESELA O ANDA BENÄ°M YAZARID 7 OLDU AMA O YAZARDETAYID YÄ° BENDEN Ã–NCE BAÅžKASI ALMIÅž OLABÄ°LÄ°R.
               //_context.Authors.Add(authorVM.Author);
               //_context.SaveChanges();        //EF ekleme, dÃ¼zenleme ve silme olarak kendisi SQL cÃ¼mlelerini oluÅŸturuyor arkaplanda. O yÃ¼zden tek SaveChanges() hallediyor.

               //if (authorVM.AuthorDetail != null)
               //{
                  //authorVM.AuthorDetail.AuthorDetailID = authorVM.Author.AuthorID;
                  //_context.AuthorDetails.Add(authorVM.AuthorDetail);
                  //_context.SaveChanges(); 
                  //return RedirectToAction("Index");
               //}
            //}
            //return View();
        //}


        //Unit Of Work Pattern UoW  - DAHA SADE - 
        BURADAKÄ° DEVRÄ°M; KONSOLA BAKTIK.
        INSERT INTO AUTHORS (FIRSTNAME, LASTNAME) VALUES (@P0, @P1);
        SELECT AUTHORID FROM AUTHORS WHERE @@ ROWCOUNT = 1 AND AUTHORID = SCOPE_IDENTITY();       //DÄ°KKAT!!! SCOPE_IDENTITY()
        INSERT INTO AUTHORDETAILS (AUTHORDETAILID, BIOGRAPHY, BIRTHDATE, REGION) VALUES (@P2, @P3, @P4, @P5);
        

        //SCOPE IDENTITY NEDÄ°R?     https://ahmetrende.com/2010/11/23/sql-serverda-son-kaydin-id-degerini-almak-scope_identity/
        Genellikle uygulamalarÄ±mÄ±zda veritabanÄ± ile baÄŸlantÄ± kurarÄ±z. Veriler Ã§eker ya da yeni kayÄ±tlar gireriz.
        Bazen bir tabloya eklediÄŸimiz kaydÄ±n ID deÄŸerine o an ihtiyaÃ§ duyabiliriz.
        
        Bunu tÃ¼rlÃ¼ yollarla yapabiliriz tabikide. Mesela kayÄ±t iÅŸleminden sonra bir select sorgusu yazÄ±p ID Kolonuna gÃ¶re ters sÄ±ralayÄ±p en Ã¼stteki satÄ±rÄ±n ID bilgisini Ã§ekebiliriz.
        Ne kadar da zahmetli ðŸ™‚
        Bu hem uzun ve yorucu hem de 2 farklÄ± transaction Ã§alÄ±ÅŸtÄ±ran bir iÅŸlem.
        
        Bunun yerine SCOPE_IDENTITY() kullanÄ±mÄ±na bakalÄ±m.
        
        
        Yandaki gibi â€œUrunlerâ€ tablomuz olsun. â€œUrunIDâ€ identity bir kolon. â€œUrunAdiâ€ ise nvarchar tipinde bir kolon.
        
        Åžimdi â€œUSB Bellekâ€ adÄ±nda farklÄ± bir kayÄ±t ekleyelim. Sorgumuz eklenen kaydÄ±n ID deÄŸerini geri dÃ¶ndÃ¼recek. Bizim tablomuza gÃ¶re â€œ4â€ deÄŸerini vermeli.
        
        1
        2
        insert into Urunler Values ('USB Bellek')
        SELECT SCOPE_IDENTITY()
        
        Sorgumuzu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda ÅŸÃ¶yle bir Ã§Ä±ktÄ± alÄ±yor olmamÄ±z gerek;
        
        Tabi ben sadece management Ã¼zerinde Ã§alÄ±ÅŸtÄ±rdÄ±m bu sorguyu. Uygulama sÄ±rasÄ±nda direk bu deÄŸeri Ã§ekebilirsiniz.
        Ya da sorgunuzda birden fazla tabloya bu ID ile kayÄ±t girmeniz gerekiyorsa, sorgu iÃ§erisinde bir deÄŸiÅŸkene bu deÄŸer atanabilir. ÅžÃ¶yleki;
        1
        2
        3
        insert into Urunler Values ('USB Bellek2')
        declare @id int
        set @id =  SCOPE_IDENTITY()
        ArtÄ±k â€œ@idâ€ deÄŸiÅŸkenini istediÄŸiniz tabloya kayÄ±t olarak girebilirsiniz.
        Son olarak;
        LinQ ya da entity framework gibi data modellerinde kullanmak iÃ§in yazacaÄŸÄ±nÄ±z store procedure sonuna yani insert sorgusundan sonra â€œselectâ€ yerine â€œreturnâ€ yazÄ±n.
        BÃ¶ylece data modelindeki metot direk olarak int deÄŸerinde ki id deÄŸerini dÃ¶ndÃ¼recektir. 
        1
        return SCOPE_IDENTITY()



        //Tek SaveChanges() metodu ile PK ve FK kullanÄ±mÄ±...
        [HttpPost]
        public IActionResult Create(AuthorVM authorVM)
        {
            byte state = 0;
                 
            if (ModelState.IsValid)
            {              
                _context.Authors.Add(authorVM.Author);

                state = 1;

                if (authorVM.AuthorDetail.BirthDate !=null || authorVM.AuthorDetail.Region != null || authorVM.AuthorDetail.Biography != null)
                {
                    authorVM.AuthorDetail.Author = authorVM.Author;        //NAVIGATION PROPERTY KULLANIM YERLERÄ°NDEN BÄ°RÄ°.
                    _context.AuthorDetails.Add(authorVM.AuthorDetail);

                   state = 2;               
                }
                _context.SaveChanges();    
            }

            if(state >1)
              return RedirectToAction("Index");
            else
              return View();
        }



        public IActionResult Test()            // DELEGE FATALITY Ä°Ã‡Ä°N KULLANILAN METOD
        {
            //int count = FindCategories().Count(); 
            //
            //
            //int count = FindAuthors("a").Count();
            //

            //int count = Finds<Category>(x=>x.CategoryID %2==1).Count();
            string word = "a";
            int count = Finds<Author>(x=>x.FirstName.ToLower().Contains(word)).Count();

            List<Author> liste = Finds<Author>(x => x.FirstName.ToLower().Contains(word));

            string sonuc = "";
            foreach(Author a in liste)
            {
                sonuc += a.FirstName;
            }
            return Content("Sonuc=" + count.ToString()  + " " + sonuc);
        }



        DELEGE FATALITY

        //KategoriID si  tek olan  kategorileri getir?
        //YazarÄ±n adÄ±nda a harfi olanlarÄ± getir?
        public List<Category> FindCategories()
        {

            //return _context.Categories.Find(id);
            return _context.Categories.Where(x=>x.CategoryID % 2==1).ToList();
        }

        public List<Author> FindAuthors(string word)
        {

            //return _context.Categories.Find(id);
            return _context.Authors.Where(x => x.FirstName.Contains(word)).ToList();
        }

        public List<TEntity> Finds<TEntity>(Func<TEntity,bool> where) where TEntity : class 
        {
            DbSet<TEntity> set = _context.Set<TEntity>();

            return _context.Set<TEntity>().Where(where).ToList();
        }
    }



2.c AuthorController Ä±n Create.cshtml ini oluÅŸturduk.

@using MVC_BookApp.Models.ViewModels;
@model AuthorVM

<form method="post" asp-area="AdminPanel" asp-controller="Authors" asp-action="Create">
    <table class="table table-striped">
        <tr>
            <td><label asp-for="Author.FirstName"></label></td>
            <td><input type="text" asp-for="Author.FirstName" class="form-control" required></input></td>
        </tr>
        <tr>
            <td><label asp-for="Author.LastName"></label></td>
            <td><input type="text" asp-for="Author.LastName" class="form-control" required></input></td>
        </tr>
        <tr>
            <td><label asp-for="AuthorDetail.BirthDate"></label></td>
            <td><input type="date" asp-for="AuthorDetail.BirthDate" class="form-control"></input></td>
        </tr>
         <tr>
            <td><label asp-for="AuthorDetail.Region"></label></td>
            <td><input type="text" asp-for="AuthorDetail.Region" class="form-control"></input></td>
        </tr>
        <tr>
            <td><label asp-for="AuthorDetail.Biography"></label></td>
            <td><textarea asp-for="AuthorDetail.Biography" class="form-control" cols="60" rows="5"></textarea></td>
        </tr>
        <tr>
            <td colspan="2"><input type="submit" value="Save Author Data" class="btn btn-primary"/></td>
            
        </tr>
    </table>
    <div asp-validation-summary="All"></div>
</form>



2.d AuthorController Ä±n Index.cshtml ini oluÅŸturduk.

@model IEnumerable<Author>

<table class="table table-striped">
    @foreach(var author in Model)
    {
    <tr>
        <td>@author.FirstName</td>
        <td>@author.LastName</td>
        @*<td>@author.AuthorDetail.BirthDate.Value.ToShortDateString()</td>*@

        <td>
            @if(author.AuthorDetail !=null)                    //DÄ°KKAT!!! LEFT JOIN YAPILDI AMA BÄ°Z NULL KONTROLÃœ KOYMADIÄžIMIZDAN GÃ–REMEMÄ°ÅžTÄ°K. 
            {
            @author.AuthorDetail.BirthDate.Value.ToString("dd/MM/yyyy")        // kÃ¼Ã§Ã¼k mm yazÄ±lmasÄ± MM ile aynÄ± deÄŸil
            }
        </td>
       
    </tr>
    }
</table>



2.e 

