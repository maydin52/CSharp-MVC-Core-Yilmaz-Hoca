
Kitap Projesi
-------------
*** MVC Core 6
*** EF Core
*** 1-1, 1-M , M-M iliÅŸkiler 
*** Identity ile uyelik Sistemi - Roller
*** Fluent API kullanÄ±mÄ±
*** Custom Validations
*** Area KullanÄ±mÄ±


Book(BookID, BookName, Price, ReleaseDate, CoverImage,CategoryID)
Author (AuthorID,AuthorName, AuthorLastName)
BookAuthor(BAID, BookID,AuthorID)
AuthorDetail(AuthorDetailID,BirthDate, Region, Biography)
Category(CategoryID, CategoryName)

Islem Basamaklari
*** Identity sistemini olustur...
*** BookDB Tasarla...
*** Modlleri olustur...
*** Context sÄ±nÄ±fndak propertyleri belirle...
*** Navigation Property'leri olustur...

-----------------

KapsamÄ±;
- Identity kullanÄ±mÄ±
- Bire Ã§ok, bire bir, Ã§oka Ã§ok kullanÄ±mÄ±
- uzantÄ±sÄ± sadece jpg olan Ã¶rneÄŸin yÃ¼kleme
- custom validation yazÄ±mÄ±
- ForeignKey annotaion kullanÄ±m zorunluluÄŸu nerede, ne iÃ§in?


Microsoft Identity seÃ§eneÄŸi farklÄ±. AraÅŸtÄ±r.

Yapay zeka Ã§eÅŸitleri;
Supervise sistemler (gpt vs. milyonlarca yazÄ±lÄ±mcÄ± gpt vb sorarak sistemi geliÅŸtiriyor sonrasÄ±nda Ã¶ÄŸrenince proramcÄ±ya gerek kalmayacak) ve unsupervise sistemler

------------------

Uygulama;

1. Create New Project - ASP.NET Core Web App(MVC) - Next - MVC_BookApp - Next - Authotantication Type : Individual Accounts ve HTTPS kliÄŸini kaldÄ±r - Create

----------------------------------------

2. Area, Identity gibi klasÃ¶rleri yeni eklemiÅŸ.
Data klasÃ¶rÃ¼ altÄ±nda Migration ve Context i kendisi oluÅŸturmuÅŸ ama dikkat DbContextten gelmiyor IdentityDbContext ten geliyor. IdentityDbContext de DbContextten geliyor. Go to definition bkz. Arada bir sÃ¼rÃ¼ generic sÄ±nÄ±f var.
Package altÄ±nda eklentileri kurmuÅŸ.
Migration klasÃ¶rÃ¼ iÃ§indeki classta Up ve Down var. Down iÃ§indekiler Ã¶zet. AspNetRoles tablosu vs. 7 tane yeni tablo oluÅŸturuyor Ã¼yelik sistemiyle alakalÄ± ve Ã§oÄŸunu Ã§oka Ã§ok iliÅŸkiyle tutuyor. 
Appsettings.json dosyasÄ±nda connection stringsi de yazmÄ±ÅŸ. Kendimize uyarlayacaÄŸÄ±z sadece. Connection strings yazÄ±lÄ±ÅŸÄ±nÄ±n birÃ§ok yazÄ±m ÅŸekli var. 
Burada Ã¶zel kullanÄ±m; (localdb) kavramÄ±; sql servere ihtiyaÃ§ duymadan da Ã§alÄ±ÅŸÄ±labiliyor ama Ã§oklu baÄŸlantÄ±larda yavaÅŸ. 2010 gibi geldi.
localdb vs kapatÄ±ldÄ±ÄŸÄ±nda uÃ§muyor. users iÃ§inde mdf ve log dosyasÄ±.
localdb ye msms olmadan vs iÃ§inden tools - connect to database - change - sql server database file seÃ§ilecek - Ok - path 
2-3 yÄ±l Ã¶nce yeni gelen Ã¶zellikle artÄ±k memory de sql server gibi kullanma Ã¶zelliÄŸi gelmiÅŸ ama aÃ§ kapa gitti. memory sql diye geÃ§iyor.
SQL de bir deÄŸiÅŸiklik yaptÄ±n diyelim migration da bu yoksa sÄ±kÄ±ntÄ±. Migration Ã¼zerinden gitmek en doÄŸrusu.

----------------------------------------

3. Migration ve identity tablolarÄ±nÄ±n oluÅŸturulmasÄ±
nuget console
update-database
sql iÃ§ndeki dabase iÃ§inde 7 tablo oluÅŸtu.

----------------------------------------

4. Modellerin oluÅŸturulmasÄ±
Tablolar ve alanlar belirlendi. Ä°LÅžKÄ°NÄ°N ADINI DOÄžRU KOYMAK GEREKÄ°YOR. YOKSA GÃ–MLEÄžÄ°N DÃœÄžMELERÄ° YANLIÅž Ä°LÄ°KLENMESÄ° GÄ°BÄ°. 
Tablolar arasÄ± iliÅŸkiler belirlendi. KullanÄ±cÄ±nÄ±n detayÄ± gÃ¶rmesi gerekli deÄŸilse join maliyeti oluÅŸmamalÄ±.
DÄ°REKT KODLAYARAK BAÅžMALAMK YANLIÅž. VERÄ°TABANI TASARIMI Ã–NCE KAÄžIT ÃœZERÄ°NDE TASARLANIR VE ONAYLANIR SONRA KODLANMAYA BAÅžLANIR.


    public class Author
    {
        public int AuthorID { get; set; }
        public string FirstName { get; set; }
        public string LastName { get; set; }

        [NotMapped]
        public string FullName { get => FirstName + " " + LastName; }

        public AuthorDetail? AuthorDetail { get; set; }
        public ICollection<BookAuthor>? AuthorBooks { get; set; }
    }



    public class AuthorDetail                      //BAÅžKA BÄ°R PROP FK OLMASINI Ä°STESEYDÄ°K ONUN Ã–NÃœNE YAZACAKTIK.
    {
        [ForeignKey("Author")]                    //DÄ°KKAT!!! HEM PK HEM FK       BÄ°REBÄ°R Ä°LÄ°ÅžKÄ°DE BÄ°R TARAF MUTLAKA FK OLMALI. PK OLDUÄžUNDAN FK EKLEDÄ°K.      VERÄ°LEN Ä°SMÄ°N Ã–NEMÄ° YOK.
        public int AuthorDetailID { get; set; }      //SQL DEN KEYS Ä°Ã‡Ä°NDEN KONTROL ETTÄ°K. HEM PK HEM FK OLARAK GÃ–RÃœNÃœYOR.
        public DateTime  BirthDate { get; set; }
        public string Region { get; set; }
        public string Biography { get; set; }


        public Author? Author { get; set; }
    }



    public class Book
    {
        public int BookID { get; set; }
        public string BookName { get; set; }
        public DateTime ReleaseDate { get; set; }
        public string CoverImagePath { get; set; }
        
        [NotMapped]
        public IFormFile CoverImage { get; set;}
        public decimal Price { get; set; }

        public int CategoryID { get; set; }


        public Category? Category { get; set; }
        public ICollection<BookAuthor>? BookAuthors  { get; set; }
    }




    public class BookAuthor
    {
        [Key]                                            //BAID YÄ° EF ANLAMAYACAÄžI Ä°Ã‡Ä°N PK OLARAK TANIMLADIK
        public int BAID { get; set; }
        public int BookID { get; set; }
        public int AuthorID { get; set; }

        public Book? Book { get; set; }
        public Author? Author { get; set; }
    }




    public class Category
    {
        public int CategoryID { get; set; }
        public string CategoryName { get; set; }

        public ICollection<Book>? Books { get; set; }
    }

------------------------------------------------------------------------

5. Context sÄ±nÄ±fÄ±ndaki propertyleri belirledik.
AÅŸaÄŸÄ±da DbSet propertyleri ekledik. Ãœsttekiler otomatik gelmiÅŸti.

    public class ApplicationDbContext : IdentityDbContext<AppUser>            //DIKKAT!!! <AppUser>  ekledik. standardÄ±n dÄ±ÅŸÄ±na Ã§Ä±kÄ±ldÄ±ÄŸÄ± iÃ§in.
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        public DbSet<Book> Books { get; set; }
        public DbSet<Category> Categories { get; set; }
        public DbSet<Author> Authors { get; set; }
        public DbSet<BookAuthor> BooksAuthors { get; set; }            //Ã‡OKA Ã‡OK Ä°LÄ°ÅžKÄ° TABLOSUNUN Ä°SMÄ°NE DÄ°KKAT
        public DbSet<AuthorDetail> AuthorDetails { get; set; }

        public DbSet<AppUser> Users { get; set; } 
    }

--------------------------------------------------------------------------

6. DB de AspNetUsers tablosunun Ã¶zelliklerine baktÄ±k ve Id nin tipinin string nvarchar(450) ve PK olduÄŸunu gÃ¶rdÃ¼k. Oraya GUID oluÅŸturuyor amagenellikle biz onu int Ã§evirmek isteriz. 
Kolay kullanÄ±lacaksa birÅŸey yapÄ±lmasÄ±na gerek yok ama burada bir customization yapacaksak birÅŸeyleri deÄŸiÅŸtirmemiz gerekecek.
Zahidin verdiÄŸi Ã¶rneÄŸe gÃ¶re adamÄ±n querystringden oynayabilmesini engellemek gerekir. Url rewriting konusu var ARAÅžTIR.
Bu tablo aynÄ± zamanda indexleneceÄŸi iÃ§in ve aynÄ± zamanda PK da olacaÄŸÄ± iÃ§in int deÄŸerlerde yani tam sayÄ± deÄŸerlerde arama hÄ±zÄ± Ã§ok yÃ¼ksek, string ifadelerde daha yavaÅŸ.
MS in string verme sebeplerinde biri de bize Ã¶zelleÅŸtirme imkanÄ± saÄŸlÄ±yor. Int verseydi stringe dÃ¶nÃ¼ÅŸtÃ¼rmek daha zor olurdu. String herÅŸeyi alabildiÄŸinden.

Ã‡alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda saÄŸ tarafta Register ve Login butonlarÄ± Ã§Ä±ktÄ±. Burada standart validasyon iÅŸlemlerinin Ã¶zellikleri bulunduruyor.
E-mail gÃ¶ndereblmek iÃ§in bir smtp servera ihtiyaÃ§ var.
Uygulama Ã¼zerinde kullanÄ±cÄ± oluÅŸturduk ve db tabloda oluÅŸan kayÄ±dÄ± kontrol ettik.
DÄ°KKAT!!! username ile e-mail aynÄ±. MS varsayÄ±lan bÃ¶yle kabul etmiÅŸ.
Login sayfasÄ±nÄ±n cshtml i gizli (DÃ¼z MVC de aÃ§Ä±k). Gelenler DLL iÃ§inden geliyor. Register ve Login ekranlarÄ±nÄ±n gÃ¶rÃ¼ntÃ¼sÃ¼ yok. NasÄ±l deÄŸiÅŸtireceÄŸiz? 3. Ã–rnekte sil baÅŸtan biz yazacaÄŸÄ±z. Ã‡Ã¼nkÃ¼ classlarÄ± var.
Proje Ã¼zerinde saÄŸ tÄ±k - Add - New Scaffolded Item - Soldaki Identity seÃ§ - Identity seÃ§ - Add - ÅŸimdilik login logut ve register seÃ§tik - context sÄ±nÄ±fÄ± seÃ§ - Add
IDENTITY - PAGES ALTINDA ACCOUNT KLASÃ–RÃœ OLUÅžTU VE CS.HML LERÄ° GELDÄ°. BURASI MVC GELMÄ°YOR. RAZOR PAGES OLARAK GEÃ‡Ä°YOR. BURADA CONTROLLER YOK. HER BÄ°RÄ°NÄ°N ALTINDA CS DOSYALARI VAR.
MVC CORE DA SADECE MVC CORE Ä°LE DEÄžÄ°L RAZOR PAGE UYGULAMASIYLA DA UYGULAMA GELÄ°ÅžTÄ°RÄ°LEBÄ°LÄ°YOR. WEB FORM KULLANIMININ BENZERÄ°.

program.cs iÃ§inde Add service to the container altÄ±ndakileri bir Ã¶nceki projede biz yazmÄ±ÅŸtÄ±k. OnlarÄ± da ÅŸimdi otomatik yazmÄ±ÅŸ.
Birincisi DbContext ayarÄ±
Ä°kincisi Identity ayarÄ±
Biz Ã¶zelleÅŸtirme yapacaÄŸÄ±mÄ±z iÃ§in bunlarÄ± yoruma aldÄ±k.

Ã–zelleÅŸtirmelerden biri;
AspNetUsers tablosunda ad, soyad ve adres bilgisi yok mesela. Bu tabloda olmayan bir verinin bu tabloda tutulmasÄ± isteniyorsa;
6.a IdentityUser sÄ±nÄ±fÄ±ndan miras alarak yeni bir sÄ±nÄ±f oluÅŸturuyoruz ve propertylerini ekliyoruz.

public class AppUser:IdentityUser
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public string Address { get; set; }
    }
6.b Context sÄ±nÄ±fÄ±na DbSet ekliyoruz.

public DbSet<AppUser> Users { get; set; } 

6.c Program.cs te aÅŸaÄŸdaki deÄŸiÅŸiklikleri yapÄ±yoruz.
BaÅŸka birÃ§ok deÄŸiÅŸiklikler de yapabiliyoruz.


// Add services to the container.
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

//AppUser=> IdentityUser Yerine KullanÄ±lacak...
builder.Services.AddDefaultIdentity<AppUser>(options => { 
    
    options.SignIn.RequireConfirmedAccount = false;
    options.Password.RequiredLength = 7;
})
    .AddEntityFrameworkStores<ApplicationDbContext>();

//Standart ÅŸekilde kullanÄ±lacaksa...
//builder.Services.AddDefaultIdentity<IdentityUser>(options => options.SignIn.RequireConfirmedAccount = true)
//    .AddEntityFrameworkStores<ApplicationDbContext>();

builder.Services.AddControllersWithViews();


6.d Views - Shared - _LoginPartial iÃ§inde en Ã¼stteki inject ler aÅŸaÄŸÄ±daki gibi deÄŸiÅŸtirildi. <IdentityUser> vardÄ± daha Ã¶nce.

@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager


6.e Migration oluÅŸturuyoruz.


6.f DB iÃ§erisinden tabloyu kontrol ediyoruz.


-----------------------------------------------------------------------------------------
09-MVC-Prj-02-2-07.10





1. Area - Identity - Pages - Account - Register.cshtml iÃ§ine, AppUser modeline eklenen Ã¶zellikleri buraya ekleyeceÄŸiz. Razor Pages yaklaÅŸÄ±mÄ±. MVC paterni veya patern yok. DÃ¼z MVC de de var.
Register.cshtml iÃ§indeki Input modelleri aÅŸaÄŸÄ±daki ÅŸekilde baÄŸlÄ±yoruz; StandardÄ±n dÄ±ÅŸÄ±na Ã§Ä±ktÄ±ÄŸÄ±mÄ±z iÃ§in bu konuya girdik.
YazÄ±lÄ±m geliÅŸtirme sÃ¼reÃ§leri Ã§ok maliyetli.
%80 kopya dÃ¶ndÃ¼ÄŸÃ¼ iÃ§in Ã§ok farketmiyoruz belki ama.


1.a Register.cshtml.cs iÃ§inde InputModel classÄ± iÃ§ine aÅŸaÄŸÄ±dakileri ekledik.
DÄ°KKAT!!! ErrorMessage iÃ§ini boÅŸ brakÄ±rsan hata alÄ±rsÄ±n.

public class InputModel
{
            [Required]
            [Display(Name = "FirstName")]
            public string FirstName { get; set; }

            [Required]
            [Display(Name = "LastName")]
            public string LastName { get; set; }

            [Required]
            //[MinLength(10, ErrorMessage =""),MaxLength(200,ErrorMessage ="")]
            [Display(Name = "Address")]
            public string Address { get; set; }



1.b Register.cshtml iÃ§inde form tagi altÄ±na aÅŸaÄŸÄ±dakileri ekledik.



            <h2>Create a new account.</h2>
            <hr />
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>


            <div class="form-floating">
                <input asp-for="Input.FirstName" class="form-control"  aria-required="true" />
                <label asp-for="Input.FirstName"></label>
                <span asp-validation-for="Input.FirstName" class="text-danger"></span>
            </div>

            <div class="form-floating">
                <input asp-for="Input.LastName" class="form-control"  aria-required="true" />
                <label asp-for="Input.LastName"></label>
                <span asp-validation-for="Input.LastName" class="text-danger"></span>
            </div>

            <div class="form-floating">
                <input asp-for="Input.Address" class="form-control" aria-required="true" />
                <label asp-for="Input.Address"></label>
                <span asp-validation-for="Input.Address" class="text-danger"></span>
            </div>


1.c Register.cshtml.cs iÃ§inde user. ile baÅŸlayan propertyler eklenmeden Ã¶nce aÅŸaÄŸÄ±daki kontrol yapÄ±ldÄ±.
DÄ°KKAT!!!

Program.cs iÃ§indeki aÅŸaÄŸÄ±da yazÄ±lÄ± olan yazÄ± iÃ§indeki RequireConfirmedAccount = false; olduÄŸundan emin olduk.
//AppUser=> IdentityUser Yerine KullanÄ±lacak...
builder.Services.AddDefaultIdentity<AppUser>(options => { 
    
    options.SignIn.RequireConfirmedAccount = false;
    options.Password.RequiredLength = 7;
})
    .AddEntityFrameworkStores<ApplicationDbContext>();


Daha sonra; Register.cshtml.cs iÃ§inde user. ile baÅŸlayan propertyler eklendi.

        public async Task<IActionResult> OnPostAsync(string returnUrl = null)
        {
            returnUrl ??= Url.Content("~/");
            ExternalLogins = (await _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();
            if (ModelState.IsValid)
            {
                var user = CreateUser(); altÄ±na

                user.FirstName = Input.FirstName;
                user.LastName=Input.LastName;
                user.Address = Input.Address;




1.d Register.cshtml.cs iÃ§inde yorum satÄ±rÄ±na alÄ±ndÄ±. Mail gÃ¶nderme ile ilgili kod.

                    //var code = await _userManager.GenerateEmailConfirmationTokenAsync(user);
                    //code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
                    //var callbackUrl = Url.Page(
                    //    "/Account/ConfirmEmail",
                    //    pageHandler: null,
                    //    values: new { area = "Identity", userId = userId, code = code, returnUrl = returnUrl },
                    //    protocol: Request.Scheme);

                    //await _emailSender.SendEmailAsync(Input.Email, "Confirm your email",
                    //    $"Please confirm your account by <a href='{HtmlEncoder.Default.Encode(callbackUrl)}'>clicking here</a>.");

Oturum yapÄ±p yapamayacaÄŸÄ±mÄ±zÄ±n testini yaptÄ±k. Yeni kullanÄ±cÄ± oluÅŸturduk ve griÅŸ yaptÄ±k.

-----

2. SQL iÃ§inden tablolardaki tipleri kontrol ettik ve deÄŸiÅŸtirilmesi gerekenleri gÃ¶rdÃ¼k.

Context sÄ±nÄ±fÄ±nda iliÅŸki ve ilk deÄŸer atamalarÄ±nÄ± yaptÄ±k.

protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            //Tum entitylerin ozellikleri buradan verilebilinir...


            builder.Entity<Category>().Property(x => x.CategoryName)
                                      .IsRequired()
                                      .HasMaxLength(30)
                                      .HasColumnType("varchar");
            
            //ilk deger atama....
            builder.Entity<Category>().HasData(
                new Category { CategoryID=1, CategoryName="Roman" },
                new Category { CategoryID=2, CategoryName="Hikaye" },
                new Category { CategoryID=3, CategoryName="Deneme" }
                );


            builder.Entity<Book>().Property(x => x.BookName).IsRequired().HasMaxLength(150).HasColumnType("varchar");
            builder.Entity<Book>().Property(x => x.CoverImagePath).IsRequired().HasMaxLength(30).HasColumnType("varchar");
            builder.Entity<Book>().Property(x => x.ReleaseDate).IsRequired(false).HasColumnType("smalldatetime");
            builder.Entity<Book>().Property(x => x.Price).IsRequired().HasColumnType("money");
            
        }

- Migration oluÅŸturduk.

------

3. Admin iÃ§in Area oluÅŸturacaÄŸÄ±z. Ã‡Ã¼nkÃ¼ admin sayfasÄ± son kullanÄ±cÄ±nÄ±nkinden farklÄ± olmalÄ±. CRUD veya kontrol paneli gibi.
Identity iÃ§in kendisi zaten oluÅŸturmuÅŸtu. Biz Admin iÃ§in olÅŸuturacaÄŸÄ±z.
Projeyi fiziksel ve mantÄ±ksal olarak ayÄ±rÄ±yor. Area larÄ±n kendi mvc leri var.

3.a Solution aÄŸacÄ±nÄ±n en Ã¼stÃ¼nde saÄŸ tÄ±k - Add - New Scaffolded Item - Sol taraftan Common seÃ§ - ortadan MVC Area seÃ§ - Add - isim ver AdminPanel - Add
Ã‡Ä±kan kodu kopyala. Kodu kaybedersen aÄŸaÃ§ta altta txt dosyasÄ± iÃ§inde.

3.b Program.cs iÃ§inde app.MapControllerRoute( gerisine yapÄ±ÅŸtÄ±r.
Bu olmadan sayfaya ulaÅŸÄ±lamazdÄ±, denedik.


Bu area altÄ±ndan aÅŸaÄŸÄ±daki controlleri oluÅŸturduk.

    [Area("AdminPanel")]    //DÄ°KKAT!!! BUNU YAZMAYI UNUTMA. DÃœZ MVC DE BU YOK. DÃœZ MVC DE KODUN BAÅžINDA SESSION VAR MI YOK MU DÄ°YE KONTROL EDÄ°LÄ°YOR. ORADAN GÃ–NDERÄ°LÄ°YOR. 
                            //DÄ°KKAT!!! CLASSIN TEPESÄ°NE YAZILACAK.
    public class PanelController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }
    }

Bu controllerin view ini oluÅŸturduk.

<h1>Admin Panel Sayfasi....</h1>

<ul>
    <li><a asp-area="AdminPanel" asp-controller="Categories" asp-action="Index">Kategoriler</a></li>
    <li>Kitaplar</li>
    <li>Yazarlar</li>
</ul>

DÄ°KKAT!!! LAYOUT GELMEDÄ°. AREA ALTINDAKÄ° IDENTITY ALTINDAKÄ° _ViewImports.cshtml ve _ViewStart.cshtml DOSYALARINI KOPYALAYIP ADMINPANEL Ä°Ã‡Ä°NDEKÄ° VIEWS KLASÃ–RÃœNE EKLE. ALT KLASÃ–RLERÄ°NDE OLMAYACAK.

-----

4. YukarÄ±daki  Index.cshtml Ã¼zerinde saÄŸ tÄ±k scaffold controller oluÅŸturduk. Model Category ve CategoriesController isminde.
Kendisi koydu ilk attribute Ã¼.

    [Area("AdminPanel")]
    public class CategoriesController : Controller
    {
        private readonly ApplicationDbContext _context;

        public CategoriesController(ApplicationDbContext context)
        {
            _context = context;
        }

        // GET: AdminPanel/Categories
        public async Task<IActionResult> Index()
        {
              return _context.Categories != null ? 
                          View(await _context.Categories.ToListAsync()) :
                          Problem("Entity set 'ApplicationDbContext.Categories'  is null.");
        }

        // GET: AdminPanel/Categories/Details/5
        public async Task<IActionResult> Details(int? id)
        {
            if (id == null || _context.Categories == null)
            {
                return NotFound();
            }

            var category = await _context.Categories
                .FirstOrDefaultAsync(m => m.CategoryID == id);
            if (category == null)
            {
                return NotFound();
            }

            return View(category);
        }

        // GET: AdminPanel/Categories/Create
        public IActionResult Create()
        {
            return View();
        }

        // POST: AdminPanel/Categories/Create
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create([Bind("CategoryID,CategoryName")] Category category)
        {
            if (ModelState.IsValid)
            {
                _context.Add(category);
                await _context.SaveChangesAsync();
                return RedirectToAction(nameof(Index));
            }
            return View(category);
        }

        // GET: AdminPanel/Categories/Edit/5
        public async Task<IActionResult> Edit(int? id)
        {
            if (id == null || _context.Categories == null)
            {
                return NotFound();
            }

            var category = await _context.Categories.FindAsync(id);
            if (category == null)
            {
                return NotFound();
            }
            return View(category);
        }

        // POST: AdminPanel/Categories/Edit/5
        // To protect from overposting attacks, enable the specific properties you want to bind to.
        // For more details, see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(int id, [Bind("CategoryID,CategoryName")] Category category)
        {
            if (id != category.CategoryID)
            {
                return NotFound();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    _context.Update(category);
                    await _context.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!CategoryExists(category.CategoryID))
                    {
                        return NotFound();
                    }
                    else
                    {
                        throw;
                    }
                }
                return RedirectToAction(nameof(Index));
            }
            return View(category);
        }

        // GET: AdminPanel/Categories/Delete/5
        public async Task<IActionResult> Delete(int? id)
        {
            if (id == null || _context.Categories == null)
            {
                return NotFound();
            }

            var category = await _context.Categories
                .FirstOrDefaultAsync(m => m.CategoryID == id);
            if (category == null)
            {
                return NotFound();
            }

            return View(category);
        }

        // POST: AdminPanel/Categories/Delete/5
        [HttpPost, ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> DeleteConfirmed(int id)
        {
            if (_context.Categories == null)
            {
                return Problem("Entity set 'ApplicationDbContext.Categories'  is null.");
            }
            var category = await _context.Categories.FindAsync(id);
            if (category != null)
            {
                _context.Categories.Remove(category);
            }
            
            await _context.SaveChangesAsync();
            return RedirectToAction(nameof(Index));
        }

        private bool CategoryExists(int id)
        {
          return (_context.Categories?.Any(e => e.CategoryID == id)).GetValueOrDefault();
        }
    }

----- scaffold views

------INDEX
@model IEnumerable<MVC_BookApp.Models.Category>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

<p>
    <a asp-action="Create">Create New</a>
</p>
<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.CategoryName)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.CategoryName)
            </td>
            <td>
                <a asp-action="Edit" asp-route-id="@item.CategoryID">Edit</a> |
                <a asp-action="Details" asp-route-id="@item.CategoryID">Details</a> |
                <a asp-action="Delete" asp-route-id="@item.CategoryID">Delete</a>
            </td>
        </tr>
}
    </tbody>
</table>

------ CREATE

@model MVC_BookApp.Models.Category

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>

<h4>Category</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="CategoryName" class="control-label"></label>
                <input asp-for="CategoryName" class="form-control" />
                <span asp-validation-for="CategoryName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

------ EDIT

@model MVC_BookApp.Models.Category

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Category</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="CategoryID" />
            <div class="form-group">
                <label asp-for="CategoryName" class="control-label"></label>
                <input asp-for="CategoryName" class="form-control" />
                <span asp-validation-for="CategoryName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

------ DETAILS

@model MVC_BookApp.Models.Category

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Category</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.CategoryName)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.CategoryName)
        </dd>
    </dl>
</div>
<div>
    <a asp-action="Edit" asp-route-id="@Model?.CategoryID">Edit</a> |
    <a asp-action="Index">Back to List</a>
</div>

-------- DELETE

@model MVC_BookApp.Models.Category

@{
    ViewData["Title"] = "Delete";
}

<h1>Delete</h1>

<h3>Are you sure you want to delete this?</h3>
<div>
    <h4>Category</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.CategoryName)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.CategoryName)
        </dd>
    </dl>
    
    <form asp-action="Delete">
        <input type="hidden" asp-for="CategoryID" />
        <input type="submit" value="Delete" class="btn btn-danger" /> |
        <a asp-action="Index">Back to List</a>
    </form>
</div>


-----------------------------------------------------------------------------------------
10-MVC-Prj-02-3-08.10



Controller iÃ§erisindeki Token nedir?
[ValidateAntiForgeryToken]
web uygulamalarÄ±nda sizin formunu dÄ±ÅŸÄ±nda baÅŸka ortamlardan veri gelmesi saÄŸlanabiliyor.
Bu onu bozuyor.
Arkada bir token oluÅŸturuyor ve bunu Ã¶n yÃ¼ze gÃ¶nderiyor.
Daha sonra serverla bu token aynÄ± olduÄŸu iÃ§in, yani baÅŸka bir yerden geldiÄŸinde bu token bilgisi olmayacaÄŸÄ± iÃ§in iÅŸlemin yapÄ±lmasÄ±nÄ± engeller.
Bu konu ayrÄ±ca anlatÄ±lacak daha sonra web servisleri anlatÄ±rken. 
JWT Json Web Token teknolojisi. Servislerin gÃ¼venliÄŸi konusunda Ã§ok kullanÄ±lÄ±yor. Zamana baÄŸlÄ± mesela 10 dk da bir tokeni deÄŸiÅŸtir diyebiliyor. Adam onu buluncaya kadar token deÄŸiÅŸiyor zaten.
jwt.io kendi resmi sitesinden baktÄ±k. Bunun ilginÃ§ bir kullanÄ±mÄ± var. ÃœÃ§ parÃ§adan oluÅŸuyor. Sitede renklendirilmiÅŸ.
Token 50 yÄ±llÄ±k teknoloji. WCF i anlatÄ±rken de token teknolojisini kullanÄ±yorduk. 
Token bir madalyonun iki parÃ§asÄ± gibi.
Client geldiÄŸinde tokenlar aynÄ±ysa bu iki kiÅŸi birbirini tanÄ±yor.
Sunucu oluÅŸturuyor. Bir kopyasÄ± bende bir kopyasÄ± clientta.
Tokenlar hashlenmiÅŸ tutuluyor. 

Sessiondaki 20 dk hareketsiz kalÄ±rsa atma olayÄ± farklÄ±. 
Core da session kullanÄ±mÄ± Ã§ok farklÄ±. DÃ¼z mantÄ±kla kullanamÄ±yorsunuz.
Core Ã¶ncesi sessionlarÄ± istediÄŸiniz gibi kullanabiliyordunuz. Core ile birlikte ilgili ayarlarÄ± yapmadan  session larÄ± kullanamÄ±yorsunuz.
Session kullanÄ±cÄ± adÄ± ve ÅŸifre ile sisteme giriÅŸ yaptÄ±nÄ±z diyelim. GiriÅŸ yaptÄ±ktan sonra sistem arka planda bir session oluÅŸturuyor. 
Bu sessionlarÄ± (herhangi bir ayarlama yapÄ±lmazsa standart ayarÄ± 20 dk.) mekanizma siz pc den uzaklaÅŸtÄ±ktan sonra klavye ve fare eventleri kesildikten sonra 
session Ã¶ldÃ¼rÃ¼lÃ¼r ve login ekranÄ±na atÄ±yor.
(core Ã¶nce 1 dk nÄ±n altÄ±na dÃ¼ÅŸemiyordunuz) (core da sn veya msn cinsinden session oluÅŸturulabiliyor.)
MantÄ±k token gibi. Ä°ki tarafta da session id bilgisi oluÅŸturuluyor. Ä°kisi aynÄ± deÄŸilse bir taraf dÃ¼ÅŸtÃ¼ÄŸÃ¼ iÃ§in null olduÄŸu iÃ§in oturum kapatÄ±lÄ±yor.

Hoca 1 lira bÄ±rakÄ±p gitmenin dÄ±ÅŸÄ±nda o sayfaya tÄ±klanÄ±p tÄ±klanmadÄ±ÄŸÄ±nÄ±n kontrol ediyormu araÅŸtÄ±racak.

MS Identity konusunda profesyonel Ã§Ã¶zÃ¼m Ã§Ä±karmÄ±ÅŸ. SÄ±fÄ±rdan yazÄ±labilir ama riskleri var. 

-------------------------------------------
MODELLER REVÄ°ZE SONRASI SON DURUM;

VÄ°EWMODELS KLASÃ–RÃœ Ä°Ã‡Ä°NDE;
public class AuthorVM
    {
        public Author Author { get; set; }
        public AuthorDetail? AuthorDetail { get; set; }
    }

public class AppUser:IdentityUser
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public string Address { get; set; }
    }

public class Author
    {
        public int AuthorID { get; set; }
        public string FirstName { get; set; }
        public string LastName { get; set; }

        [NotMapped]
        public string FullName { get => FirstName + " " + LastName; }

        public AuthorDetail? AuthorDetail { get; set; }
        public ICollection<BookAuthor>? AuthorBooks { get; set; }
    }

public class AuthorDetail
    {
        [ForeignKey("Author")]
        public int AuthorDetailID { get; set; }

        [DisplayFormat(DataFormatString ="{0:d}")]
        public DateTime?  BirthDate { get; set; }
        public string? Region { get; set; }
        public string? Biography { get; set; }


        public Author? Author { get; set; }
    }

public class Book
    {
        public int BookID { get; set; }
        public string BookName { get; set; }
        public DateTime? ReleaseDate { get; set; }
        public string CoverImagePath { get; set; }
        
        [NotMapped]
        public IFormFile CoverImage { get; set;}
        public decimal Price { get; set; }

        public int CategoryID { get; set; }


        public Category? Category { get; set; }
        public ICollection<BookAuthor>? BookAuthors  { get; set; }
    }

public class BookAuthor
    {
        [Key]
        public int BAID { get; set; }
        public int BookID { get; set; }
        public int AuthorID { get; set; }

        public Book? Book { get; set; }
        public Author? Author { get; set; }
    }

public class Category
    {
        public int CategoryID { get; set; }
        public string CategoryName { get; set; }

        public ICollection<Book>? Books { get; set; }
    }


-------------------------------------------


1. Area - AdminPanel - Panel 

Index.cshtml bir Ã¶nceki gÃ¼ndeki eski. AÅŸaÄŸÄ±daki sekilde revize.

<h1>Admin Panel Sayfasi....</h1>

<ul>
    <li><a asp-area="AdminPanel" asp-controller="Categories" asp-action="Index">Kategoriler</a></li>
    <li><a asp-area="AdminPanel" asp-controller="Authors" asp-action="Index">Yazarlar</a></li>
    <li><a asp-area="AdminPanel" asp-controller="Books" asp-action="Index">Kitaplar</a></li>
</ul>

PK FK iliÅŸkisi gereÄŸi eÄŸer kitap tablosuyla yazar tablosunu iliÅŸkilendireceksem Ã¶nce yazar tablosunu halletmeliyiz.

------

2. Author ve AuthorDetail tablolarÄ± birleÅŸtirilerek tek ekranda veri giriliÅŸi


2.a Ä°ki tabloyu view e taÅŸÄ±mak iÃ§in; Models klasÃ¶rÃ¼ altÄ±nda ViewModels klasÃ¶rÃ¼ aÃ§arak onun altÄ±na AuthorVM classÄ± ekliyoruz.

 public class AuthorVM
    {
        public Author Author { get; set; }
        public AuthorDetail? AuthorDetail { get; set; }
    }


2.b AuthorsController Ä± oluÅŸturduk.

    [Area("AdminPanel")]
    public class AuthorsController : Controller
    {
        private readonly ApplicationDbContext _context;

        public AuthorsController(ApplicationDbContext context)
        {
            _context = context;
        }

        public IActionResult Index()
        {

            return View(_context.Authors.Include("AuthorDetail").ToList());
        }

        public IActionResult Create()
        {
            return View();
        }


        //UNIT OF WORK OLMADAN Ä°KÄ° DEFA SAVE Ä°LE. DÄ°KKAT MAHSURU VAR.
        //[HttpPost]
        //public IActionResult Create(AuthorVM authorVM)
        //{    
            //if (ModelState.IsValid)
            //{              
               //Ä°ki SaveChanges() ile; FAKAT BURADA ÅžÃ–YLE BÄ°R SIKINTI VAR; MESELA O ANDA BENÄ°M YAZARID 7 OLDU AMA O YAZARDETAYID YÄ° BENDEN Ã–NCE BAÅžKASI ALMIÅž OLABÄ°LÄ°R.
               //_context.Authors.Add(authorVM.Author);
               //_context.SaveChanges();        //EF ekleme, dÃ¼zenleme ve silme olarak kendisi SQL cÃ¼mlelerini oluÅŸturuyor arkaplanda. O yÃ¼zden tek SaveChanges() hallediyor.

               //if (authorVM.AuthorDetail != null)
               //{
                  //authorVM.AuthorDetail.AuthorDetailID = authorVM.Author.AuthorID;
                  //_context.AuthorDetails.Add(authorVM.AuthorDetail);
                  //_context.SaveChanges(); 
                  //return RedirectToAction("Index");
               //}
            //}
            //return View();
        //}


        //Unit Of Work Pattern UoW  - DAHA SADE - 
        BURADAKÄ° DEVRÄ°M; KONSOLA BAKTIK.
        INSERT INTO AUTHORS (FIRSTNAME, LASTNAME) VALUES (@P0, @P1);
        SELECT AUTHORID FROM AUTHORS WHERE @@ ROWCOUNT = 1 AND AUTHORID = SCOPE_IDENTITY();       //DÄ°KKAT!!! SCOPE_IDENTITY()
        INSERT INTO AUTHORDETAILS (AUTHORDETAILID, BIOGRAPHY, BIRTHDATE, REGION) VALUES (@P2, @P3, @P4, @P5);
        

        //SCOPE IDENTITY NEDÄ°R?     https://ahmetrende.com/2010/11/23/sql-serverda-son-kaydin-id-degerini-almak-scope_identity/
        Genellikle uygulamalarÄ±mÄ±zda veritabanÄ± ile baÄŸlantÄ± kurarÄ±z. Veriler Ã§eker ya da yeni kayÄ±tlar gireriz.
        Bazen bir tabloya eklediÄŸimiz kaydÄ±n ID deÄŸerine o an ihtiyaÃ§ duyabiliriz.
        
        Bunu tÃ¼rlÃ¼ yollarla yapabiliriz tabikide. Mesela kayÄ±t iÅŸleminden sonra bir select sorgusu yazÄ±p ID Kolonuna gÃ¶re ters sÄ±ralayÄ±p en Ã¼stteki satÄ±rÄ±n ID bilgisini Ã§ekebiliriz.
        Ne kadar da zahmetli ðŸ™‚
        Bu hem uzun ve yorucu hem de 2 farklÄ± transaction Ã§alÄ±ÅŸtÄ±ran bir iÅŸlem.
        
        Bunun yerine SCOPE_IDENTITY() kullanÄ±mÄ±na bakalÄ±m.
        
        
        Yandaki gibi â€œUrunlerâ€ tablomuz olsun. â€œUrunIDâ€ identity bir kolon. â€œUrunAdiâ€ ise nvarchar tipinde bir kolon.
        
        Åžimdi â€œUSB Bellekâ€ adÄ±nda farklÄ± bir kayÄ±t ekleyelim. Sorgumuz eklenen kaydÄ±n ID deÄŸerini geri dÃ¶ndÃ¼recek. Bizim tablomuza gÃ¶re â€œ4â€ deÄŸerini vermeli.
        
        1
        2
        insert into Urunler Values ('USB Bellek')
        SELECT SCOPE_IDENTITY()
        
        Sorgumuzu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda ÅŸÃ¶yle bir Ã§Ä±ktÄ± alÄ±yor olmamÄ±z gerek;
        
        Tabi ben sadece management Ã¼zerinde Ã§alÄ±ÅŸtÄ±rdÄ±m bu sorguyu. Uygulama sÄ±rasÄ±nda direk bu deÄŸeri Ã§ekebilirsiniz.
        Ya da sorgunuzda birden fazla tabloya bu ID ile kayÄ±t girmeniz gerekiyorsa, sorgu iÃ§erisinde bir deÄŸiÅŸkene bu deÄŸer atanabilir. ÅžÃ¶yleki;
        1
        2
        3
        insert into Urunler Values ('USB Bellek2')
        declare @id int
        set @id =  SCOPE_IDENTITY()
        ArtÄ±k â€œ@idâ€ deÄŸiÅŸkenini istediÄŸiniz tabloya kayÄ±t olarak girebilirsiniz.
        Son olarak;
        LinQ ya da entity framework gibi data modellerinde kullanmak iÃ§in yazacaÄŸÄ±nÄ±z store procedure sonuna yani insert sorgusundan sonra â€œselectâ€ yerine â€œreturnâ€ yazÄ±n.
        BÃ¶ylece data modelindeki metot direk olarak int deÄŸerinde ki id deÄŸerini dÃ¶ndÃ¼recektir. 
        1
        return SCOPE_IDENTITY()



        //Tek SaveChanges() metodu ile PK ve FK kullanÄ±mÄ±...
        [HttpPost]
        public IActionResult Create(AuthorVM authorVM)
        {
            byte state = 0;
                 
            if (ModelState.IsValid)
            {              
                _context.Authors.Add(authorVM.Author);

                state = 1;

                if (authorVM.AuthorDetail.BirthDate !=null || authorVM.AuthorDetail.Region != null || authorVM.AuthorDetail.Biography != null)
                {
                    authorVM.AuthorDetail.Author = authorVM.Author;        //NAVIGATION PROPERTY KULLANIM YERLERÄ°NDEN BÄ°RÄ°.
                    _context.AuthorDetails.Add(authorVM.AuthorDetail);

                   state = 2;               
                }
                _context.SaveChanges();    
            }

            if(state >1)
              return RedirectToAction("Index");
            else
              return View();
        }



        public IActionResult Test()            // DELEGE FATALITY Ä°Ã‡Ä°N KULLANILAN METOD
        {
            //int count = FindCategories().Count(); 
            //
            //
            //int count = FindAuthors("a").Count();
            //

            //int count = Finds<Category>(x=>x.CategoryID %2==1).Count();
            string word = "a";
            int count = Finds<Author>(x=>x.FirstName.ToLower().Contains(word)).Count();

            List<Author> liste = Finds<Author>(x => x.FirstName.ToLower().Contains(word));

            string sonuc = "";
            foreach(Author a in liste)
            {
                sonuc += a.FirstName;
            }
            return Content("Sonuc=" + count.ToString()  + " " + sonuc);
        }



        DELEGE FATALITY

        //KategoriID si  tek olan  kategorileri getir?
        //YazarÄ±n adÄ±nda a harfi olanlarÄ± getir?
        public List<Category> FindCategories()
        {

            //return _context.Categories.Find(id);
            return _context.Categories.Where(x=>x.CategoryID % 2==1).ToList();
        }

        public List<Author> FindAuthors(string word)
        {

            //return _context.Categories.Find(id);
            return _context.Authors.Where(x => x.FirstName.Contains(word)).ToList();
        }

        public List<TEntity> Finds<TEntity>(Func<TEntity,bool> where) where TEntity : class 
        {
            DbSet<TEntity> set = _context.Set<TEntity>();

            return _context.Set<TEntity>().Where(where).ToList();
        }
    }



2.c AuthorController Ä±n Create.cshtml ini oluÅŸturduk.

@using MVC_BookApp.Models.ViewModels;
@model AuthorVM

<form method="post" asp-area="AdminPanel" asp-controller="Authors" asp-action="Create">
    <table class="table table-striped">
        <tr>
            <td><label asp-for="Author.FirstName"></label></td>
            <td><input type="text" asp-for="Author.FirstName" class="form-control" required></input></td>
        </tr>
        <tr>
            <td><label asp-for="Author.LastName"></label></td>
            <td><input type="text" asp-for="Author.LastName" class="form-control" required></input></td>
        </tr>
        <tr>
            <td><label asp-for="AuthorDetail.BirthDate"></label></td>
            <td><input type="date" asp-for="AuthorDetail.BirthDate" class="form-control"></input></td>
        </tr>
         <tr>
            <td><label asp-for="AuthorDetail.Region"></label></td>
            <td><input type="text" asp-for="AuthorDetail.Region" class="form-control"></input></td>
        </tr>
        <tr>
            <td><label asp-for="AuthorDetail.Biography"></label></td>
            <td><textarea asp-for="AuthorDetail.Biography" class="form-control" cols="60" rows="5"></textarea></td>
        </tr>
        <tr>
            <td colspan="2"><input type="submit" value="Save Author Data" class="btn btn-primary"/></td>
            
        </tr>
    </table>
    <div asp-validation-summary="All"></div>
</form>



2.d AuthorController Ä±n Index.cshtml ini oluÅŸturduk.

@model IEnumerable<Author>

<table class="table table-striped">
    @foreach(var author in Model)
    {
    <tr>
        <td>@author.FirstName</td>
        <td>@author.LastName</td>
        @*<td>@author.AuthorDetail.BirthDate.Value.ToShortDateString()</td>*@

        <td>
            @if(author.AuthorDetail !=null)                    //DÄ°KKAT!!! LEFT JOIN YAPILDI AMA BÄ°Z NULL KONTROLÃœ KOYMADIÄžIMIZDAN GÃ–REMEMÄ°ÅžTÄ°K. 
            {
            @author.AuthorDetail.BirthDate.Value.ToString("dd/MM/yyyy")        // kÃ¼Ã§Ã¼k mm yazÄ±lmasÄ± MM ile aynÄ± deÄŸil
            }
        </td>
       
    </tr>
    }
</table>



-----------------------------------------------------------------------------------------
11-MVC-Prj-02-4-14_15.10



Ã‡OKA Ã‡OK Ä°LÄ°ÅžKÄ° 


1. VM OluÅŸturulmasÄ±

public class BookVM
    {
        public Book Book { get; set; }
        public SelectList Categories  { get; set; }
        public SelectList Authors  { get; set; }

        public string GetIDs { get; set; }
        //public ICollection<int> AuthorID { get; set; }
    }




2. Areas - AdminPanel - Controllers - BookController

    [Area("AdminPanel")]
    [Authorize]            //    ARTIK OTURUM AÃ‡ILDIÄžINDA BURAYA GÄ°RÄ°Åž YAPILABÄ°LÄ°R. DÄ°KKAT AREAS - ADMINPANEL ALTINDAKÄ° TÃœM CONTROLLERLARA EKLE.
    public class BookController : Controller
    {
        private readonly ApplicationDbContext _context;

        public BookController(ApplicationDbContext context)
        {
            _context = context;
        }

        public IActionResult Index()
        {
            return View(_context.Books.Include("Category").ToList());
        }

        public IActionResult Create()
        {
            BookVM bookVM = new BookVM();

            bookVM.Categories = new SelectList(_context.Categories, "CategoryID", "CategoryName");
            bookVM.Authors = new SelectList(_context.Authors, "AuthorID", "FullName");
            //bookVM.AuthorID = new List<int>();
            return View(bookVM);
        }


        // DÄ°KKAT !!! HANGÄ° VERÄ°LERÄ°N GELÄ°P GELMEDÄ°ÄžÄ°NE BU ÅžEKÄ°LDE KONTROL ETTÄ°.
        //[HttpPost]
        //public IActionResult Create(IFormCollection frm)
        //{
            //string str = "";

            //foreach (var s in frm)
                //str += s.Key + "=>" + s.Value + " ";

            //return Content("authorName" + str)            //DÄ°KKAT!!! SCRÄ°PT TAGÄ° Ä°Ã‡Ä°NDE GEÃ‡Ä°YOR authorName
        //}


        [HttpPost]
        public IActionResult Create(Book book, string getIds)
        {
            string[] authorIDs = getIds.Split(' ');
            //Console.WriteLine(authorIDs.Length);
            List<BookAuthor> authors = new List<BookAuthor>();
            for (int i= 0;i < authorIDs.Length - 1;i++)            //ENSONDAKÄ° BOÅžLUKTAN KURTULMAK Ä°Ã‡Ä°N
            {
                authors.Add(new BookAuthor { AuthorID = int.Parse(authorIDs[i]), Book = book });  //AUTHORID LER HIDDEN DAN GELÄ°YOR. DÄ°KKAT! Book = book BOOK TABLOSUNA BÄ°RÅžEY YAZMADIM. UOW
            }

            book.BookAuthors = authors;    // YUKARIDAKÄ° LÄ°ST Ä° NAV PROP ATTIK.

            _context.Books.Add(book);
            _context.BooksAuthors.AddRange(authors);    // BÄ°RDEN FAZLA OLDUÄžUNDAN
            _context.SaveChanges();        //UOW

            return RedirectToAction("Index");
        }
    }



3. BookController Ä±n Index.cshtml

@model IEnumerable<Book>

    <a asp-area="AdminPanel" asp-controller="Book" asp-action="Create">Add a Book</a>
    <br />
<table>
@foreach(Book book in Model)
{
    <tr>
        <td>@book.BookName</td>
        <td>@book.Category.CategoryName</td>
        <td>@book.Price</td>
    </tr>
}
</table>




4. BookController Ä±n Create.cshtml

@using MVC_BookApp.Models.ViewModels;
@model BookVM


// BURADA DAHA BASÄ°T BÄ°R Ã‡Ã–ZÃœM KÄ° ÅžÃ–YLE; HER BÄ°R SEÃ‡Ä°LEN Ä°Ã‡Ä°N SUNUCUYA GÄ°DÄ°P SORDURABÄ°LÄ°RDÄ°K. AMA BU ÅžEKÄ°LDE SUNUCUYA TEK SEFERDE GÄ°TTÄ°K. HER SEÃ‡Ä°LENÄ°N KÄ°M OLDUÄžUNU SORMAK Ä°Ã‡Ä°N GÄ°TMEDÄ°K.
<script>
    function selectAuthor(data)
    {
        //Secilen ad....
        let text = data.options[data.selectedIndex].text;
        //let frm = document.getElementById("frmBook");
        let authors = document.getElementById("authorsDiv");
        let hidden = document.getElementById("Ids");

        let input = document.createElement("input");
        //let label =document.createElement("label");
        input.type="text";                                            //SEÃ‡Ä°LDÄ°KÃ‡E EKLENEN TEXTBOX
        input.value= text;
        input.readOnly=true;
        input.name = data.value;
        
        input.addEventListener("click",(e)=>{ 
            let id=e.target.name;
            let authors = document.getElementById("authorsDiv");
            let hidden = document.getElementById("Ids");
          
            hidden.value = hidden.value.replace(id+" ", "");    //BOÅžLUKTAN DOLAYI Ã‡IKMIYORDU.
            authors.removeChild(e.target);
        });
     

        hidden.value += data.value + " ";
      
        authors.appendChild(input);                
        // FORMUN Ä°Ã‡Ä°NE EKLE DEMEK. NESNEYÄ° OLUÅžTURMAK EKRANDA GÃ–RÃœNMESÄ° Ä°Ã‡Ä°N YETERLÄ° DEÄžÄ°L. 
        // O KOLEKSÄ°YONA EKLENMESÄ° GEREK. WÄ°NDOWS FORMDAKÄ° THÄ°SLE EKLEME GÄ°BÄ°.
        // DÄ°ÄžER TÃœRLÃœ RAMDE VARDIR AMA EKRAN GÃ–RÃœNTÃœSÃœ YOKTUR.
  
    }

   
</script>

<form method="post" enctype="multipart/form-data" asp-area="AdminPanel" asp-controller="Book" asp-action="Create" id="frmBook">
<table class="table table-striped">
    <tr>
        <td><label asp-for="Book.BookName"></label></td>
        <td><input type="text" asp-for=Book.BookName class="form-control" /></td>
    </tr>
        <tr>
            <td><label asp-for="Book.ReleaseDate"></label></td>
            <td><input type="date" asp-for=Book.ReleaseDate class="form-control" /></td>
        </tr>
        <tr>
            <td><label asp-for="Book.Category"></label></td>
            <td><select  asp-for=Book.CategoryID asp-items=Model.Categories class="form-control"></select></td>
        </tr>
        <tr>
            <td><label asp-for="Book.Price"></label></td>
            <td><input type="text" data-type="currency" asp-for=Book.Price class="form-control" /></td>
        </tr>

        <tr>
            <td><label asp-for="Book.CoverImage"></label></td>
            <td><input type="file"  asp-for=Book.CoverImage class="form-control" />
                <input type="hidden" asp-for=Book.CoverImagePath class="form-control" value="empty.jpg" />
            </td>
        </tr>
        <tr>
            @*<td><label asp-for=""></label></td>*@
            <td>Authors</td>
            <td>
                <select asp-items=Model.Authors class="form-control" onchange="selectAuthor(this)">
                    <option value="" disabled selected hidden>Seciniz... </option >
                </select>
                <input type="hidden" id="Ids" value="" name="GetIDs"/>
                <ul id="authorsDiv" >

                </ul>
            </td>
        </tr>

        <tr>
            <td colspan="2">
                <input type="submit" value="Add Book" />
            </td>
        </tr>
</table>
</form>



               


